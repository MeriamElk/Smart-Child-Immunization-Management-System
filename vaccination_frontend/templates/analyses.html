{% extends "base.html" %}

{% block title %}Analyses - VacciTrack{% endblock %}

{% block content %}
<div class="analyses-container">
    <div class="page-header">
        <h1>Analyses et statistiques</h1>
        <div class="date-filter">
            <label for="dateRange">Période</label>
            <select id="dateRange" class="form-control">
                <option value="7">7 derniers jours</option>
                <option value="30">30 derniers jours</option>
                <option value="90">3 derniers mois</option>
                <option value="365">1 an</option>
                <option value="all">Tout</option>
            </select>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-syringe"></i>
            </div>
            <div class="stat-info">
                <h3>Vaccinations totales</h3>
                <p class="stat-number">{{ stats.total_vaccinations }}</p>
                <span class="stat-trend {{ 'positive' if stats.tendance_vaccinations > 0 else 'negative' }}">
                    <i class="fas fa-arrow-{{ 'up' if stats.tendance_vaccinations > 0 else 'down' }}"></i>
                    {{ stats.tendance_vaccinations }}%
                </span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>Taux de couverture</h3>
                <p class="stat-number">{{ stats.taux_couverture }}%</p>
                <span class="stat-trend {{ 'positive' if stats.tendance_couverture > 0 else 'negative' }}">
                    <i class="fas fa-arrow-{{ 'up' if stats.tendance_couverture > 0 else 'down' }}"></i>
                    {{ stats.tendance_couverture }}%
                </span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <h3>Vaccins en retard</h3>
                <p class="stat-number">{{ stats.vaccins_retard }}</p>
                <span class="stat-trend {{ 'positive' if stats.tendance_retard < 0 else 'negative' }}">
                    <i class="fas fa-arrow-{{ 'down' if stats.tendance_retard < 0 else 'up' }}"></i>
                    {{ stats.tendance_retard }}%
                </span>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h2>Vaccinations par type</h2>
            <div id="vaccinationsTypeChart" class="chart"></div>
        </div>
        <div class="chart-card">
            <h2>Évolution des vaccinations</h2>
            <div id="evolutionChart" class="chart"></div>
        </div>
        <div class="chart-card">
            <h2>Couverture par âge</h2>
            <div id="couvertureAgeChart" class="chart"></div>
        </div>
        <div class="chart-card">
            <h2>Statut des vaccinations</h2>
            <div id="statutVaccinationsChart" class="chart"></div>
        </div>
    </div>

    <div class="reports-section">
        <h2>Rapports détaillés</h2>
        <div class="reports-grid">
            <div class="report-card">
                <h3>Vaccins les plus administrés</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Vaccin</th>
                                <th>Nombre</th>
                                <th>% du total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vaccin in stats.vaccins_populaires %}
                            <tr>
                                <td>{{ vaccin.nom }}</td>
                                <td>{{ vaccin.nombre }}</td>
                                <td>{{ vaccin.pourcentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="report-card">
                <h3>Alertes récentes</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nombre</th>
                                <th>Tendance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alerte in stats.alertes_recentes %}
                            <tr>
                                <td>{{ alerte.type }}</td>
                                <td>{{ alerte.nombre }}</td>
                                <td>
                                    <span class="trend-badge {{ 'positive' if alerte.tendance < 0 else 'negative' }}">
                                        <i class="fas fa-arrow-{{ 'down' if alerte.tendance < 0 else 'up' }}"></i>
                                        {{ alerte.tendance }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
.analyses-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.date-filter {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.date-filter label {
    color: var(--gray-600);
    font-size: 0.875rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--white);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--light-blue);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--primary-blue);
}

.stat-icon.success {
    background: var(--light-green);
    color: var(--success);
}

.stat-icon.warning {
    background: #FEF3C7;
    color: #D97706;
}

.stat-info h3 {
    color: var(--gray-600);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.stat-number {
    color: var(--gray-800);
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.stat-trend {
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.stat-trend.positive {
    color: var(--success);
}

.stat-trend.negative {
    color: var(--danger);
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: var(--white);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.chart-card h2 {
    color: var(--gray-800);
    font-size: 1.25rem;
    margin-bottom: 1.5rem;
}

.chart {
    height: 300px;
}

.reports-section {
    margin-bottom: 2rem;
}

.reports-section h2 {
    color: var(--gray-800);
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

.report-card {
    background: var(--white);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.report-card h3 {
    color: var(--gray-800);
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.table-responsive {
    overflow-x: auto;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th {
    background: var(--gray-100);
    font-weight: 600;
    text-align: left;
    padding: 1rem;
}

.table td {
    padding: 1rem;
    border-top: 1px solid var(--gray-200);
}

.trend-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.trend-badge.positive {
    background: var(--light-green);
    color: var(--success);
}

.trend-badge.negative {
    background: #FEE2E2;
    color: var(--danger);
}

@media (max-width: 768px) {
    .analyses-container {
        padding: 1rem;
    }
    
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .reports-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Données pour les graphiques
const vaccinationsTypeData = {
    labels: ['Obligatoire', 'Recommandé'],
    values: [65, 35],
    type: 'pie',
    marker: {
        colors: ['#4A90E2', '#7ED321']
    }
};

const evolutionData = {
    x: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin'],
    y: [120, 150, 180, 160, 200, 220],
    type: 'scatter',
    mode: 'lines+markers',
    name: 'Vaccinations',
    line: {
        color: '#4A90E2'
    }
};

const couvertureAgeData = {
    x: ['0-6m', '6-12m', '1-2a', '2-3a', '3-4a', '4-5a'],
    y: [95, 90, 85, 80, 75, 70],
    type: 'bar',
    marker: {
        color: '#4A90E2'
    }
};

const statutVaccinationsData = {
    labels: ['À jour', 'En retard', 'Urgent'],
    values: [70, 20, 10],
    type: 'pie',
    marker: {
        colors: ['#7ED321', '#F59E0B', '#DC2626']
    }
};

// Configuration des graphiques
const layout = {
    margin: { t: 20, r: 20, b: 40, l: 40 },
    showlegend: false,
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: {
        family: 'inherit'
    }
};

// Création des graphiques
Plotly.newPlot('vaccinationsTypeChart', [vaccinationsTypeData], {
    ...layout,
    height: 300
});

Plotly.newPlot('evolutionChart', [evolutionData], {
    ...layout,
    height: 300,
    xaxis: {
        title: 'Mois'
    },
    yaxis: {
        title: 'Nombre de vaccinations'
    }
});

Plotly.newPlot('couvertureAgeChart', [couvertureAgeData], {
    ...layout,
    height: 300,
    xaxis: {
        title: 'Âge'
    },
    yaxis: {
        title: 'Taux de couverture (%)'
    }
});

Plotly.newPlot('statutVaccinationsChart', [statutVaccinationsData], {
    ...layout,
    height: 300
});

// Mise à jour des graphiques lors du changement de période
document.getElementById('dateRange').addEventListener('change', function() {
    const period = this.value;
    // Ici, vous pouvez ajouter une requête AJAX pour récupérer les nouvelles données
    // et mettre à jour les graphiques en conséquence
});
</script>
{% endblock %} 
{% extends "base.html" %}

{% block title %}Gestion des vaccins - VacciTrack{% endblock %}

{% block content %}
<div class="vaccins-container">
    <div class="page-header">
        <h1>Gestion des vaccins</h1>
        {% if current_user.role in ['admin', 'medecin'] %}
        <button class="btn btn-primary" onclick="openModal('ajouterVaccinModal')">
            <i class="fas fa-plus"></i> Ajouter un vaccin
        </button>
        {% endif %}
    </div>

    <div class="search-bar">
        <div class="search-input">
            <i class="fas fa-search"></i>
            <input type="text" id="searchVaccin" placeholder="Rechercher un vaccin..." class="form-control">
        </div>
        <div class="filter-group">
            <select id="filterType" class="form-control">
                <option value="">Tous les types</option>
                <option value="obligatoire">Obligatoire</option>
                <option value="recommandé">Recommandé</option>
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Âge recommandé</th>
                    <th>Nombre de doses</th>
                    <th>Intervalle</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for vaccin in vaccins %}
                <tr>
                    <td>{{ vaccin.nom_vaccin }}</td>
                    <td>
                        <span class="type-badge {{ vaccin.type_vaccin|lower }}">
                            {{ vaccin.type_vaccin }}
                        </span>
                    </td>
                    <td>{{ vaccin.age_recommande }} mois</td>
                    <td>{{ vaccin.nombre_doses }}</td>
                    <td>{{ vaccin.effets_secondaires or 'N/A' }}</td>
                    <td class="actions">
                        <button class="btn-icon" onclick="openModal('voirVaccinModal', {{ vaccin.vaccin_id }})" title="Voir détails">
                            <i class="fas fa-eye"></i>
                        </button>
                        {% if current_user.role in ['admin', 'medecin'] %}
                        <button class="btn-icon" onclick="openModal('modifierVaccinModal', {{ vaccin.vaccin_id }})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon danger" onclick="confirmerSuppression({{ vaccin.vaccin_id }})" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="no-data">Aucun vaccin enregistré</td>
                </tr>
                {% endfor %}
            </tbody>            
        </table>
    </div>
</div>

<!-- Modal Ajouter Vaccin -->
<div id="ajouterVaccinModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Ajouter un vaccin</h2>
            <button class="close-btn" onclick="closeModal('ajouterVaccinModal')">&times;</button>
        </div>
        <form id="ajouterVaccinForm" method="POST" action="{{ url_for('create_vaccin') }}">
            <div class="form-group">
                <label for="nom">Nom du vaccin</label>
                <input type="text" id="nom" name="nom" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="type">Type</label>
                <select id="type" name="type" class="form-control" required>
                    <option value="">Sélectionner...</option>
                    <option value="obligatoire">Obligatoire</option>
                    <option value="recommandé">Recommandé</option>
                </select>
            </div>
            <div class="form-group">
                <label for="age_recommande">Âge recommandé (mois)</label>
                <input type="number" id="age_recommande" name="age_recommande" class="form-control" required min="0">
            </div>
            <div class="form-group">
                <label for="nombre_doses">Nombre de doses</label>
                <input type="number" id="nombre_doses" name="nombre_doses" class="form-control" required min="1">
            </div>
            <div class="form-group">
                <label for="intervalle">Intervalle entre doses (mois)</label>
                <input type="number" id="intervalle" name="intervalle" class="form-control" required min="0">
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('ajouterVaccinModal')">Annuler</button>
                <button type="submit" class="btn btn-primary">Ajouter</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Modifier Vaccin -->
<div id="modifierVaccinModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Modifier le vaccin</h2>
            <button class="close-btn" onclick="closeModal('modifierVaccinModal')">&times;</button>
        </div>
        <form id="modifierVaccinForm" method="POST">
            <div class="form-group">
                <label for="edit_nom">Nom du vaccin</label>
                <input type="text" id="edit_nom" name="nom" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit_type">Type</label>
                <select id="edit_type" name="type" class="form-control" required>
                    <option value="obligatoire">Obligatoire</option>
                    <option value="recommandé">Recommandé</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit_age_recommande">Âge recommandé (mois)</label>
                <input type="number" id="edit_age_recommande" name="age_recommande" class="form-control" required min="0">
            </div>
            <div class="form-group">
                <label for="edit_nombre_doses">Nombre de doses</label>
                <input type="number" id="edit_nombre_doses" name="nombre_doses" class="form-control" required min="1">
            </div>
            <div class="form-group">
                <label for="edit_intervalle">Intervalle entre doses (mois)</label>
                <input type="number" id="edit_intervalle" name="intervalle" class="form-control" required min="0">
            </div>
            <div class="form-group">
                <label for="edit_description">Description</label>
                <textarea id="edit_description" name="description" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('modifierVaccinModal')">Annuler</button>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Voir Vaccin -->
<div id="voirVaccinModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Détails du vaccin</h2>
            <button class="close-btn" onclick="closeModal('voirVaccinModal')">&times;</button>
        </div>
        <div class="vaccin-details">
            <div class="detail-group">
                <label>Nom</label>
                <p id="detail_nom"></p>
            </div>
            <div class="detail-group">
                <label>Type</label>
                <p id="detail_type"></p>
            </div>
            <div class="detail-group">
                <label>Âge recommandé</label>
                <p id="detail_age"></p>
            </div>
            <div class="detail-group">
                <label>Nombre de doses</label>
                <p id="detail_doses"></p>
            </div>
            <div class="detail-group">
                <label>Intervalle entre doses</label>
                <p id="detail_intervalle"></p>
            </div>
            <div class="detail-group">
                <label>Description</label>
                <p id="detail_description"></p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('voirVaccinModal')">Fermer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.vaccins-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.search-bar {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.search-input {
    position: relative;
    flex: 1;
    max-width: 400px;
}

.search-input i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
}

.search-input input {
    padding-left: 2.5rem;
}

.filter-group {
    min-width: 200px;
}

.table-responsive {
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    overflow: hidden;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th {
    background: var(--gray-100);
    font-weight: 600;
    text-align: left;
    padding: 1rem;
}

.table td {
    padding: 1rem;
    border-top: 1px solid var(--gray-200);
}

.type-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.type-badge.obligatoire {
    background: var(--light-blue);
    color: var(--primary-blue);
}

.type-badge.recommandé {
    background: var(--light-green);
    color: var(--success);
}

.actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    background: none;
    border: none;
    color: var(--gray-600);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: var(--gray-100);
    color: var(--primary-blue);
}

.btn-icon.danger:hover {
    background: #FEE2E2;
    color: var(--danger);
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--white);
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 1.25rem;
    color: var(--gray-800);
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--gray-500);
    cursor: pointer;
}

.modal form {
    padding: 1.5rem;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
}

.vaccin-details {
    padding: 1.5rem;
}

.detail-group {
    margin-bottom: 1rem;
}

.detail-group label {
    display: block;
    color: var(--gray-600);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.detail-group p {
    color: var(--gray-800);
    font-size: 1rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--gray-200);
    text-align: right;
}

@media (max-width: 768px) {
    .vaccins-container {
        padding: 1rem;
    }
    
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .search-bar {
        flex-direction: column;
    }
    
    .search-input {
        max-width: none;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .actions {
        flex-wrap: wrap;
    }
}
</style>

<script>
// Fonction de recherche et filtrage
document.getElementById('searchVaccin').addEventListener('input', filterVaccins);
document.getElementById('filterType').addEventListener('change', filterVaccins);

function filterVaccins() {
    const searchTerm = document.getElementById('searchVaccin').value.toLowerCase();
    const typeFilter = document.getElementById('filterType').value.toLowerCase();
    const rows = document.querySelectorAll('.table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const type = row.querySelector('.type-badge').textContent.toLowerCase();
        const matchesSearch = text.includes(searchTerm);
        const matchesType = !typeFilter || type === typeFilter;
        
        row.style.display = matchesSearch && matchesType ? '' : 'none';
    });
}

// Fonction pour confirmer la suppression
function confirmerSuppression(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce vaccin ?')) {
        fetch(`/vaccin/supprimer/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        });
    }
}

// Fonction pour charger les détails d'un vaccin
function chargerDetailsVaccin(id) {
    fetch(`/vaccin/${id}`)
        .then(response => response.json())
        .then(data => {
            console.log(data);  // ✅ VOIR si l'API renvoie bien les données attendues

            document.getElementById('detail_nom').textContent = data.nom;
            document.getElementById('detail_type').textContent = data.type;
            document.getElementById('detail_age').textContent = `${data.age_recommande} mois`;
            document.getElementById('detail_doses').textContent = data.nombre_doses;
            document.getElementById('detail_intervalle').textContent = `${data.intervalle} mois`;
            document.getElementById('detail_description').textContent = data.description || 'Aucune description';
        })
        .catch(error => console.error('Erreur fetch vaccin:', error));
}

// Fonction pour charger les données de modification
function chargerModificationVaccin(id) {
    fetch(`/vaccin/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_nom').value = data.nom;
            document.getElementById('edit_type').value = data.type;
            document.getElementById('edit_age_recommande').value = data.age_recommande;
            document.getElementById('edit_nombre_doses').value = data.nombre_doses;
            document.getElementById('edit_intervalle').value = data.intervalle;
            document.getElementById('edit_description').value = data.description || '';
            document.getElementById('modifierVaccinForm').action = `/vaccin/modifier/${id}`;
        });
}

// Gestion des modales
function openModal(modalId, vaccinId = null) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'flex';
    
    if (modalId === 'voirVaccinModal' && vaccinId) {
        chargerDetailsVaccin(vaccinId);
    } else if (modalId === 'modifierVaccinModal' && vaccinId) {
        chargerModificationVaccin(vaccinId);
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Fermeture des modales en cliquant en dehors
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %} 